{% extends 'base.html' %}

{% block head %}
<!--LOAD PRE-REQUISITES FOR GOOGLE SIGN IN -->
<html itemscope itemtype="http://schema.org/Article">
<meta name="Description" content="Login page for Yamagata Hotels; Description: Hotel and lodging listings, Location: Yamagata Yamagata Japan">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://apis.google.com/js/client:platform.js?onload=start" async defer></script>
<!-- END PRE-REQUISITES FOR GOOGLE SIGN IN -->
<script>
  function start() {
    gapi.load('auth2', function() {
      auth2 = gapi.auth2.init({
        client_id: '936000743443-1lb8midi1epefonrqg2r55cdoiag0tgg.apps.googleusercontent.com',
        // Scopes to request in addition to 'profile' and 'email'
        //scope: 'additional_scope'
      });
    });
  }
</script>
{% endblock %}

{% block body %}

<!-- GOOGLE SIGN IN BUTTON -->
<section class="lay-content">
    {% if 'username' not in session %}
    <div class="lay-box">
        <div class="login-box">
            <h1 class="login-title">Google Login</h1>
            <button id="signinButton" class="btn signin-btn hotels-btn">Sign in with Google</button>
        </div>
    </div>

    {% else %}
    <div class="lay-box">
        <div class="login-box">
            <h3 class="center-text">You are already logged in!</br>Head on over to the <a class="sub-link" href="{{ url_for('showHotels', hotels=hotels) }}" title="Hotel listings">Hotel listings</a> page.</h3>
        </div>
    </div>
    {% endif %}
</section>

<script>
  $('#signinButton').click(function() {
    // signInCallback defined in step 6.
    auth2.grantOfflineAccess().then(signInCallback);
  });
</script>
<!-- /GOOGLE SIGNIN BUTTON -->

<div class="result">
    <div id="result"></div>
</div>

<script>
function signInCallback(authResult) {
  if (authResult['code']) {

    // Hide the sign-in button now that the user is authorized, for example:
    $('#signinButton').attr('style', 'display: none');

    // Send the code to the server
    $.ajax({
      type: 'POST',
      url: '/gconnect?state={{STATE}}',
      // Always include an `X-Requested-With` header in every AJAX request,
      // to protect against CSRF attacks.
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      },
      contentType: 'application/octet-stream; charset=utf-8',
      success: function(result) {
          if (result) {
            $('#result').html('Login Successful!</br>'+ result + '</br>Redirecting...')
           setTimeout(function() {
            window.location.href = "/hotels";
        }, 4000);}
      },
      processData: false,
      data: authResult['code']
    });
  } else if (authResult['error']) {
    console.log('There was an error: ' + authResult['error']);
  } else {
        $('#result').html('Failed to make a server-side call. Check your configuration and console.');
         }
}
</script>
{% endblock %}
